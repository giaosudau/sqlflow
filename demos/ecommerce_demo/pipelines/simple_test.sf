-- Simple Test Pipeline for Ecommerce Data Analysis
--
-- Business Purpose: 
--   This pipeline demonstrates a simple data workflow that loads sales data from CSV files,
--   transforms it to calculate revenue metrics, and exports the results to S3 storage.
--   This represents a basic analytics workflow that would be used to calculate daily
--   sales performance in an ecommerce business.
--
-- Pipeline Steps: Load data → Transform → Export to S3

-- Define data sources
SOURCE sales TYPE CSV PARAMS {
  "path": "data/sales_2023-10-25.csv",
  "has_header": true
};

SOURCE customers TYPE CSV PARAMS {
  "path": "data/customers.csv",
  "has_header": true
};

SOURCE products TYPE CSV PARAMS {
  "path": "data/products.csv",
  "has_header": true
};

-- Load data into tables
LOAD raw_sales FROM sales;
LOAD customers_table FROM customers;
LOAD products_table FROM products;

-- Create sales summary with revenue calculation
-- Business context: This transformation calculates the total revenue for each order
-- which is a fundamental business metric for financial reporting.
CREATE TABLE sales_summary AS
SELECT 
  s.order_id,
  s.customer_id,
  s.product_id,
  s.quantity,
  s.price,
  (CAST(s.quantity AS DOUBLE) * CAST(s.price AS DOUBLE)) AS total_amount
FROM raw_sales s;


EXPORT SELECT * FROM sales_summary
TO "s3://analytics/reports/sales_summary_${date}"
TYPE S3
OPTIONS {
  "format": "parquet",
  "compression": "snappy",
  "endpoint_url": "http://localhost:9000",
  "region": "us-east-1",
  "access_key": "minioadmin",
  "secret_key": "minioadmin",
  "bucket": "analytics"
};
